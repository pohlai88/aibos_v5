<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Employee Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body class="bg-gray-100">
  <div class="max-w-4xl mx-auto mt-8 bg-white rounded shadow p-6">
    <h1 class="text-2xl font-bold mb-4">Employee Dashboard</h1>
    <!-- Auth Section -->
    <div id="auth-section" class="mb-6">
      <div id="login-form">
        <input id="email" type="email" placeholder="Email" class="border p-2 rounded mr-2" />
        <input id="password" type="password" placeholder="Password" class="border p-2 rounded mr-2" />
        <button onclick="login()" class="bg-blue-500 text-white px-4 py-2 rounded">Login</button>
        <button onclick="signup()" class="ml-2 text-blue-500">Sign Up</button>
      </div>
      <div id="user-info" class="hidden">
        <span id="user-email" class="font-semibold"></span>
        <button onclick="logout()" class="ml-4 text-red-500">Logout</button>
      </div>
    </div>
    <!-- Tabs -->
    <div class="mb-4">
      <button class="tab-btn px-4 py-2 mr-2 bg-blue-100 rounded" onclick="showTab('chat')">Chat</button>
      <button class="tab-btn px-4 py-2 mr-2 bg-blue-100 rounded" onclick="showTab('approvals')">Approvals/Inquiries</button>
      <button class="tab-btn px-4 py-2 mr-2 bg-blue-100 rounded" onclick="showTab('tasks')">Tasks</button>
      <button class="tab-btn px-4 py-2 mr-2 bg-blue-100 rounded" onclick="showTab('documents')">Documents</button>
      <button class="tab-btn px-4 py-2 mr-2 bg-blue-100 rounded" onclick="showTab('notifications')">Notifications</button>
      <button class="tab-btn px-4 py-2 bg-blue-100 rounded" onclick="showTab('profile')">Profile</button>
      <button class="tab-btn px-4 py-2 bg-blue-100 rounded" onclick="showTab('audit')">Audit/History</button>
    </div>
    <!-- Tab Contents -->
    <div id="tab-chat" class="tab-content hidden">
      <h2 class="text-xl font-semibold mb-2">Chat</h2>
      <div class="mb-2">
        <button onclick="showChatType('private')" class="px-2 py-1 bg-gray-200 rounded mr-2">Private</button>
        <button onclick="showChatType('project')" class="px-2 py-1 bg-gray-200 rounded">Project</button>
      </div>
      <div id="chat-list" class="mb-4"></div>
      <div id="chat-window" class="border rounded p-4 h-64 overflow-y-auto mb-2 bg-gray-50"></div>
      <div id="chat-input-section" class="flex">
        <input id="chat-input" type="text" class="flex-1 border p-2 rounded mr-2" placeholder="Type a message..." />
        <button onclick="sendMessage()" class="bg-blue-500 text-white px-4 py-2 rounded">Send</button>
      </div>
    </div>
    <div id="tab-approvals" class="tab-content hidden">
      <h2 class="text-xl font-semibold mb-2">Approvals / Inquiries</h2>
      <div id="approval-list" class="mb-4"></div>
      <form id="approval-form" class="mb-2 flex flex-col md:flex-row gap-2">
        <input id="approval-title" type="text" placeholder="Title" class="border p-2 rounded flex-1" required />
        <input id="approval-desc" type="text" placeholder="Description" class="border p-2 rounded flex-1" required />
        <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded">Submit</button>
      </form>
    </div>
    <div id="tab-tasks" class="tab-content hidden">
      <h2 class="text-xl font-semibold mb-2">My Tasks</h2>
      <div id="task-list"></div>
    </div>
    <div id="tab-documents" class="tab-content hidden">
      <h2 class="text-xl font-semibold mb-2">Documents</h2>
      <form id="upload-form" class="mb-2 flex flex-col md:flex-row gap-2">
        <input id="doc-title" type="text" placeholder="Title" class="border p-2 rounded flex-1" required />
        <input id="doc-file" type="file" class="border p-2 rounded flex-1" required />
        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Upload</button>
      </form>
      <div id="document-list"></div>
    </div>
    <div id="tab-notifications" class="tab-content hidden">
      <h2 class="text-xl font-semibold mb-2">Notifications</h2>
      <div id="notification-list"></div>
    </div>
    <div id="tab-profile" class="tab-content hidden">
      <h2 class="text-xl font-semibold mb-2">Profile / Settings</h2>
      <div id="profile-info"></div>
      <form id="profile-form" class="mt-4 flex flex-col md:flex-row gap-2">
        <input id="profile-name" type="text" placeholder="Name" class="border p-2 rounded flex-1" />
        <input id="profile-email" type="email" placeholder="Email" class="border p-2 rounded flex-1" />
        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Update</button>
      </form>
    </div>
    <div id="tab-audit" class="tab-content hidden">
      <h2 class="text-xl font-semibold mb-2">Audit / History</h2>
      <div id="audit-list"></div>
    </div>
  </div>
  <script>
    // --- CONFIG ---
    const SUPABASE_URL = 'https://YOUR_PROJECT.supabase.co'; // TODO: Replace with your Supabase URL
    const SUPABASE_ANON_KEY = 'YOUR_ANON_KEY'; // TODO: Replace with your Supabase anon key
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- UI Helpers ---
    function showTab(tab) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
      document.getElementById('tab-' + tab).classList.remove('hidden');
    }
    showTab('chat'); // Default tab

    // --- Auth ---
    async function login() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const { error, user, session } = await supabase.auth.signInWithPassword({ email, password });
      if (error) return alert(error.message);
      onAuthChange();
    }
    async function signup() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const { error, user } = await supabase.auth.signUp({ email, password });
      if (error) return alert(error.message);
      alert('Signup successful! Please check your email to confirm.');
    }
    async function logout() {
      await supabase.auth.signOut();
      onAuthChange();
    }
    async function onAuthChange() {
      const { data: { user } } = await supabase.auth.getUser();
      if (user) {
        document.getElementById('login-form').classList.add('hidden');
        document.getElementById('user-info').classList.remove('hidden');
        document.getElementById('user-email').textContent = user.email;
        loadDashboard(user);
      } else {
        document.getElementById('login-form').classList.remove('hidden');
        document.getElementById('user-info').classList.add('hidden');
        clearDashboard();
      }
    }
    supabase.auth.onAuthStateChange(onAuthChange);
    onAuthChange();

    // --- Dashboard Data Loaders (placeholders, to be implemented) ---
    async function loadDashboard(user) {
      // Load chat, approvals, tasks, documents, notifications, profile, audit
      // TODO: Implement each loader below
      loadChats(user);
      loadApprovals(user);
      loadTasks(user);
      loadDocuments(user);
      loadNotifications(user);
      loadProfile(user);
      loadAudit(user);
    }
    function clearDashboard() {
      // Clear all dashboard sections
      document.getElementById('chat-list').innerHTML = '';
      document.getElementById('chat-window').innerHTML = '';
      document.getElementById('approval-list').innerHTML = '';
      document.getElementById('task-list').innerHTML = '';
      document.getElementById('document-list').innerHTML = '';
      document.getElementById('notification-list').innerHTML = '';
      document.getElementById('profile-info').innerHTML = '';
      document.getElementById('audit-list').innerHTML = '';
    }

    // --- Chat ---
    let currentChatType = 'private';
    let currentChatId = null;
    let chatSubscription = null;

    async function loadChats(user) {
      showChatType(currentChatType, user);
    }

    async function showChatType(type, user = null) {
      currentChatType = type;
      document.getElementById('chat-list').innerHTML = `<div class='text-gray-500'>Loading ${type} chats...</div>`;
      document.getElementById('chat-window').innerHTML = '';
      document.getElementById('chat-input').value = '';
      currentChatId = null;
      if (!user) {
        const { data: { user: u } } = await supabase.auth.getUser();
        user = u;
      }
      if (!user) return;
      let { data: chats, error } = await supabase
        .from('chats')
        .select('*')
        .eq('is_group', type === 'project')
        .order('created_at', { ascending: false });
      if (error) {
        document.getElementById('chat-list').innerHTML = `<div class='text-red-500'>Error loading chats</div>`;
        return;
      }
      // Filter chats where user is a participant
      let { data: participants } = await supabase
        .from('chat_participants')
        .select('*')
        .eq('user_id', user.id);
      const userChatIds = new Set(participants.map(p => p.chat_id));
      chats = chats.filter(c => userChatIds.has(c.id));
      if (chats.length === 0) {
        document.getElementById('chat-list').innerHTML = `<div class='text-gray-500'>No ${type} chats found.</div>`;
        return;
      }
      document.getElementById('chat-list').innerHTML =
        chats.map(c => `<button class="block w-full text-left px-2 py-1 rounded hover:bg-blue-50 mb-1" onclick="selectChat('${c.id}')">${c.name || 'Private Chat'}</button>`).join('');
    }

    async function selectChat(chatId) {
      currentChatId = chatId;
      document.getElementById('chat-window').innerHTML = '<div class="text-gray-500">Loading messages...</div>';
      // Unsubscribe previous
      if (chatSubscription) chatSubscription.unsubscribe();
      // Load messages
      let { data: messages, error } = await supabase
        .from('messages')
        .select('*')
        .eq('chat_id', chatId)
        .order('created_at', { ascending: true });
      if (error) {
        document.getElementById('chat-window').innerHTML = '<div class="text-red-500">Error loading messages</div>';
        return;
      }
      renderMessages(messages);
      // Subscribe to new messages
      chatSubscription = supabase
        .channel('chat_' + chatId)
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `chat_id=eq.${chatId}` }, payload => {
          addMessage(payload.new);
        })
        .subscribe();
    }

    function renderMessages(messages) {
      document.getElementById('chat-window').innerHTML = messages.map(m => `<div class="mb-2"><span class="font-semibold">${m.sender_id}</span>: ${m.content}<div class="text-xs text-gray-400">${new Date(m.created_at).toLocaleString()}</div></div>`).join('');
    }
    function addMessage(message) {
      document.getElementById('chat-window').innerHTML += `<div class="mb-2"><span class="font-semibold">${message.sender_id}</span>: ${message.content}<div class="text-xs text-gray-400">${new Date(message.created_at).toLocaleString()}</div></div>`;
      document.getElementById('chat-window').scrollTop = document.getElementById('chat-window').scrollHeight;
    }

    async function sendMessage() {
      if (!currentChatId) return alert('Select a chat first!');
      const content = document.getElementById('chat-input').value;
      if (!content.trim()) return;
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return alert('Not logged in');
      const { error } = await supabase.from('messages').insert([
        { chat_id: currentChatId, sender_id: user.id, content }
      ]);
      if (error) return alert('Error sending message: ' + error.message);
      document.getElementById('chat-input').value = '';
    }

    // --- Approvals/Inquiries ---
    let approvalSubscription = null;
    async function loadApprovals(user) {
      document.getElementById('approval-list').innerHTML = '<div class="text-gray-500">Loading approvals...</div>';
      if (approvalSubscription) approvalSubscription.unsubscribe();
      // Load approvals where user is requester or assignee
      let { data: approvals, error } = await supabase
        .from('approvals')
        .select('*')
        .or(`requester_id.eq.${user.id},assignee_id.eq.${user.id}`)
        .order('created_at', { ascending: false });
      if (error) {
        document.getElementById('approval-list').innerHTML = '<div class="text-red-500">Error loading approvals</div>';
        return;
      }
      renderApprovals(approvals);
      // Subscribe to new approvals
      approvalSubscription = supabase
        .channel('approvals')
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'approvals', filter: `requester_id=eq.${user.id}` }, payload => {
          addApproval(payload.new);
        })
        .subscribe();
    }
    function renderApprovals(approvals) {
      if (!approvals || approvals.length === 0) {
        document.getElementById('approval-list').innerHTML = '<div class="text-gray-500">No approvals found.</div>';
        return;
      }
      document.getElementById('approval-list').innerHTML = approvals.map(a =>
        `<div class="mb-2 p-2 border rounded">
          <div class="font-semibold">${a.title || 'Approval'}</div>
          <div class="text-sm text-gray-600">${a.description || ''}</div>
          <div class="text-xs text-gray-400">Status: ${a.status || 'pending'} | ${new Date(a.created_at).toLocaleString()}</div>
        </div>`
      ).join('');
    }
    function addApproval(approval) {
      const el = document.createElement('div');
      el.className = 'mb-2 p-2 border rounded';
      el.innerHTML = `<div class="font-semibold">${approval.title || 'Approval'}</div>
        <div class="text-sm text-gray-600">${approval.description || ''}</div>
        <div class="text-xs text-gray-400">Status: ${approval.status || 'pending'} | ${new Date(approval.created_at).toLocaleString()}</div>`;
      document.getElementById('approval-list').prepend(el);
    }
    document.getElementById('approval-form').onsubmit = async function(e) {
      e.preventDefault();
      const title = document.getElementById('approval-title').value;
      const description = document.getElementById('approval-desc').value;
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return alert('Not logged in');
      const { error } = await supabase.from('approvals').insert([
        { title, description, requester_id: user.id, status: 'pending' }
      ]);
      if (error) return alert('Error submitting approval: ' + error.message);
      document.getElementById('approval-title').value = '';
      document.getElementById('approval-desc').value = '';
    };

    // --- Tasks (placeholder) ---
    function loadTasks(user) {
      document.getElementById('task-list').innerHTML = '<div class="text-gray-500">Loading tasks...</div>';
      // TODO: Load tasks from Supabase
    }

    // --- Documents (placeholder) ---
    function loadDocuments(user) {
      document.getElementById('document-list').innerHTML = '<div class="text-gray-500">Loading documents...</div>';
      // TODO: Load documents from Supabase
    }
    document.getElementById('upload-form').onsubmit = function(e) {
      e.preventDefault();
      // TODO: Upload document to Supabase Storage
      alert('Upload document (to be implemented)');
    };

    // --- Notifications (placeholder) ---
    function loadNotifications(user) {
      document.getElementById('notification-list').innerHTML = '<div class="text-gray-500">Loading notifications...</div>';
      // TODO: Load notifications from Supabase
    }

    // --- Profile/Settings (placeholder) ---
    function loadProfile(user) {
      document.getElementById('profile-info').innerHTML = `<div>Email: ${user.email}</div>`;
      // TODO: Load and update profile info
    }
    document.getElementById('profile-form').onsubmit = function(e) {
      e.preventDefault();
      // TODO: Update profile info in Supabase
      alert('Update profile (to be implemented)');
    };

    // --- Audit/History (placeholder) ---
    function loadAudit(user) {
      document.getElementById('audit-list').innerHTML = '<div class="text-gray-500">Loading audit/history...</div>';
      // TODO: Load audit/history from Supabase
    }
  </script>
</body>
</html> 